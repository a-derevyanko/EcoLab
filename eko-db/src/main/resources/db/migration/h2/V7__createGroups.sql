DROP INDEX ix_auth_username;

ALTER TABLE AUTHORITIES RENAME TO USER_AUTHORITIES;

ALTER TABLE USER_AUTHORITIES DROP COLUMN AUTHORITY;

ALTER TABLE GROUPS
  ADD CONSTRAINT GROUP_NAME_UNIQUE UNIQUE (GROUP_NAME);

CREATE UNIQUE INDEX ix_group_names
  ON groups (GROUP_NAME);

INSERT INTO groups (GROUP_NAME)
VALUES ('ADMINS'),
  ('TEACHERS'),
  ('STUDENTS');

ALTER TABLE GROUP_AUTHORITIES DROP COLUMN AUTHORITY;

CREATE TABLE AUTHORITIES (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY ( START WITH 0) PRIMARY KEY,
  version        INT,
  authority_name VARCHAR(256) NOT NULL UNIQUE
);

DROP INDEX ix_authorities;

CREATE UNIQUE INDEX ix_authorities
  ON authorities (id);

ALTER TABLE USER_AUTHORITIES ADD AUTHORITY_ID BIGINT;
ALTER TABLE USER_AUTHORITIES ADD FOREIGN KEY (AUTHORITY_ID) REFERENCES AUTHORITIES(ID) ON DELETE CASCADE;

ALTER TABLE GROUP_AUTHORITIES ADD AUTHORITY_ID BIGINT;
ALTER TABLE GROUP_AUTHORITIES ADD FOREIGN KEY (AUTHORITY_ID) REFERENCES AUTHORITIES(ID) ON DELETE CASCADE;

INSERT INTO authorities (id, version, authority_name)
VALUES (0, 0, 'ADMIN'),
  (1, 0, 'TEACHER'),
  (2, 0, 'STUDENT');

INSERT INTO group_authorities (GROUP_ID, AUTHORITY_ID)
VALUES (0, 0),
  (0, 1),
  (0, 2),
  (1, 0),
  (1, 1),
  (2, 2);

UPDATE user_authorities set AUTHORITY_ID=1;

ALTER TABLE USER_AUTHORITIES ALTER COLUMN AUTHORITY_ID SET NOT NULL;

ALTER TABLE GROUP_AUTHORITIES ALTER COLUMN AUTHORITY_ID SET NOT NULL;

INSERT INTO GROUP_MEMBERS (USER_ID, GROUP_ID)
VALUES (0, 0),
  (1, 0);